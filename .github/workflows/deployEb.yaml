# .github/workflows/deploy.yml
name: Deploy to EC2

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
        - name: Checkout code
          uses: actions/checkout@v3

        - name: Set up Node.js
          uses: actions/setup-node@v3
          with:
            node-version: '16'

        - name: Install dependencies
          run: npm install

        - name: Package application
          run: zip -r app.zip .

        - name: Deploy to EC2
          uses: appleboy/scp-action@v0.1.3
          with:
            host: ${{ secrets.EC2_HOST }}
            username: ${{ secrets.EC2_USER }}
            key: ${{ secrets.EC2_KEY }}
            source: "app.zip"
            target: "~/app.zip"

        - name: SSH to EC2 and deploy
          uses: appleboy/ssh-action@v0.1.6
          with:
            host: ${{ secrets.EC2_HOST }}
            username: ${{ secrets.EC2_USER }}
            key: ${{ secrets.EC2_KEY }}
            script: |
                sudo yum update
                sudo yum install -y unzip 
                rm -rf ~/app
                cd app.zip
                unzip app.zip -d ~/app
                cd ~/app
                npm install
                pm2 stop all || true
                pm2 start app.js --name "my-app"